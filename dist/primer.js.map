{"version":3,"file":"primer.js","sourceRoot":"","sources":["../src/primer.ts"],"names":[],"mappings":"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","sourcesContent":["import { join } from 'path';\n\nimport { cleanPath } from './path';\nimport PireError from './error';\nimport type {\n\tBodyFilterBuilderParams,\n\tBodyFilterBuilderConfig,\n\tHttpMethod,\n\tJson,\n\tPireMethodPrimer,\n\tPirePrimer,\n\tPirePrimerFunction,\n} from './types';\n\n/**\n * Converts method primers to primers in object syntax\n * @param primers\n * @returns\n */\nexport function objectifyLocalPrimers(primers: PireMethodPrimer[] = []): PirePrimer[] {\n\treturn primers.map((p) => ({\n\t\tfn: typeof p === 'function' ? p.bind({}) : p.fn,\n\t\tcleanup: p.cleanup,\n\t}));\n}\n\n/**\n * Prepares the given primers for use by building paths for includes and excludes and\n * converting function form primers to standard form primers\n * @param primers to prepare\n * @param path where the primers were given\n * @returns prepared primers\n */\nexport function preparePrimers(\n\tprimers: (PirePrimer | PirePrimerFunction)[],\n\tpath: string\n): PirePrimer[] {\n\treturn primers.map((p) => ({\n\t\tfn: typeof p === 'function' ? p.bind({}) : p.fn,\n\t\tcleanup: p.cleanup,\n\t\tincludes:\n\t\t\tp.includes &&\n\t\t\tp.includes.map((v) => ({\n\t\t\t\tpath: cleanPath(v.path.charAt(0) === '.' ? join(path, v.path) : v.path),\n\t\t\t\tmethods: v.methods,\n\t\t\t})),\n\t\texcludes:\n\t\t\tp.excludes &&\n\t\t\tp.excludes.map((v) => ({\n\t\t\t\tpath: cleanPath(v.path.charAt(0) === '.' ? join(path, v.path) : v.path),\n\t\t\t\tmethods: v.methods,\n\t\t\t})),\n\t\tid: p.id || (typeof p === 'function' ? p.name : undefined),\n\t}));\n}\n\n/**\n * Filters primers for a specific path and method\n * @param primers filter from\n * @param path\n * @param method\n * @returns filtered primers\n */\nexport function primersBuilder(\n\tprimers: PirePrimer[],\n\tpath: string,\n\tmethod: HttpMethod,\n\texcludePrimers: string[]\n): PirePrimer[] {\n\tconst arr: PirePrimer[] = [];\n\tconst ids: Record<string, true> = {};\n\n\tprimers.forEach((p) => {\n\t\t// IDs must be unique\n\t\tif (p.id) {\n\t\t\tif (ids[p.id]) {\n\t\t\t\tthrow `Multiple primers found in the same context with the id '${p.id}'`;\n\t\t\t}\n\t\t\tids[p.id] = true;\n\t\t}\n\t\t// Filter ids\n\t\tif (\n\t\t\t(p.id && excludePrimers.includes(p.id)) ||\n\t\t\t(p.excludes &&\n\t\t\t\tp.excludes.some((v) => {\n\t\t\t\t\treturn (\n\t\t\t\t\t\t(v.methods === 'ALL' || v.methods === method || v.methods.includes(method)) &&\n\t\t\t\t\t\tv.path === path\n\t\t\t\t\t);\n\t\t\t\t}))\n\t\t) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (p.includes) {\n\t\t\tif (\n\t\t\t\tp.includes.some((v) => {\n\t\t\t\t\treturn (\n\t\t\t\t\t\t(v.methods === 'ALL' || v.methods === method || v.methods.includes(method)) &&\n\t\t\t\t\t\tv.path === path\n\t\t\t\t\t);\n\t\t\t\t})\n\t\t\t)\n\t\t\t\treturn arr.push(p);\n\t\t} else {\n\t\t\tarr.push(p);\n\t\t}\n\t});\n\n\treturn arr;\n}\n\n/**\n * Converts list of missing properties to human intelligable string\n */\nexport function stringifyMissingList(list: string[]): string {\n\tconst last = list.pop();\n\tif (!list.length) return last;\n\treturn `${list.join(', ')} and ${last}`;\n}\n\n/**\n * Creates a primer that adds a filtered version of body to params.primed\n * @param params.permitted list of permitted properties on body\n * @param params.required list of required properties on body, all elements are automatically\n * set as permitted\n * @param params.defaults object containing default values to set for properties on body, all\n * properties on `defaults` are automatically set as permitted\n * @param config.missingRequiredSendable custom sendable for in case a required property is missing\n * from body\n * @param config.bodyNotObjectSendable custom sendable for in case body isn't a processable object\n * @returns body filter primer\n */\nexport function bodyFilterBuilder(\n\tparams: BodyFilterBuilderParams,\n\tconfig: BodyFilterBuilderConfig = {}\n): PireMethodPrimer {\n\tconst { permitted = [], required = [], defaults = {} } = params;\n\tconst {\n\t\tmissingRequiredSendable = {\n\t\t\tstatus: 'Unprocessable Entity',\n\t\t\tdata: 'Missing required fields from body: {{missingRequiredFields}}',\n\t\t},\n\t\tbodyNotObjectSendable = { status: 'Unprocessable Entity', data: 'Invalid body' },\n\t} = config;\n\n\tconst defaultKeys = Object.keys(defaults);\n\tconst filter = [...permitted, ...required, ...defaultKeys];\n\treturn {\n\t\tfn: (params) => {\n\t\t\tif (typeof params.body !== 'object' || params.body instanceof Array)\n\t\t\t\tthrow new PireError(bodyNotObjectSendable);\n\t\t\t// All required properties present\n\t\t\tconst missingRequiredFields = [];\n\t\t\trequired.forEach((req) => {\n\t\t\t\tif (typeof params.body[req] === 'undefined') missingRequiredFields.push(req);\n\t\t\t});\n\t\t\tif (missingRequiredFields.length)\n\t\t\t\tthrow new PireError({\n\t\t\t\t\tstatus: missingRequiredSendable.status,\n\t\t\t\t\tdata:\n\t\t\t\t\t\ttypeof missingRequiredSendable.data === 'string'\n\t\t\t\t\t\t\t? missingRequiredSendable.data.replace(\n\t\t\t\t\t\t\t\t\t'{{missingRequiredFields}}',\n\t\t\t\t\t\t\t\t\tstringifyMissingList(missingRequiredFields)\n\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t: missingRequiredSendable.data,\n\t\t\t\t});\n\t\t\t// Exclude all unfiltered parameters\n\t\t\tconst result: Record<string, Json> = {};\n\t\t\tfilter.forEach((f) => {\n\t\t\t\tif (typeof params.body[f] !== 'undefined') result[f] = params.body[f];\n\t\t\t});\n\t\t\t// Set defaults\n\t\t\tdefaultKeys.forEach((def) => {\n\t\t\t\tif (result[def] === undefined) {\n\t\t\t\t\tconst value = defaults[def];\n\t\t\t\t\tif (typeof value === 'function') result[def] = value(params);\n\t\t\t\t\telse result[def] = value;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\treturn { primed: { ...params.primed, body: result } };\n\t\t},\n\t};\n}\n"]}